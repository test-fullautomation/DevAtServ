#!/bin/bash

set -e

source /opt/devatserv/share/util/format.sh

CURRENT_USER=${SUDO_USER}
if [ -z ${CURRENT_USER} ]; then
   CURRENT_USER=$(whoami)
fi
# When executing as root user $HOME can be /root
# Otherwises, /home/<user> should be used
if [ ${CURRENT_USER} != 'root' ]; then
   HOME=/home/${CURRENT_USER}
fi

# Introduce group `robot-aio` which allow access for group of multiple users
sGROUP=devatserv


if [ "$(id -u)" = "0" ]; then
   # Run with sudo
   if [ ! $(getent group $sGROUP) ]; then
      addgroup $sGROUP
   fi
   usermod -a -G $sGROUP ${CURRENT_USER}
   echo -e "Using group ${sGROUP} as user group for devatserv permission"
else
   if [ ! $(getent group $sGROUP) ]; then
      echo -e "${MSG_ERR} User group '$sGROUP' is not found"
      echo -e "${MSG_ERR} Please verify the installation of devatserv"
      exit 1
   fi

   if groups ${CURRENT_USER} | grep $sGROUP; then
      echo -e "${MSG_INFO} User '${CURRENT_USER}' already belongs to group '$sGROUP'"
   else
      echo -e "${MSG_ERR} Please add '${CURRENT_USER}' to group '$sGROUP' as below command then try again"
      echo -e "${MSG_ERR} sudo usermod -a -G $sGROUP ${CURRENT_USER}"
      exit 1
   fi
fi


# Configure Unitiy Launchers folder
APPS_PATH=${HOME}/.local/share/applications
if [ -e "${APPS_PATH}" ]; then
   # Check whether it is file or directory
   # remove it in case it is fine then create appropriate directory 
   if [ -f "${APPS_PATH}" ]; then
      rm "${APPS_PATH}"
      mkdir "${APPS_PATH}"
   fi
else
   # Create applications launcher folder if not existing
   mkdir "${APPS_PATH}"
fi


echo -e "${MSG_DONE} Device Automation Services App has been successfully created/updated."
cp /opt/devatserv/share/applications/devatserv.desktop ${APPS_PATH}/devatserv.desktop
chown -R "${CURRENT_USER}:${sGROUP}" ${APPS_PATH}/devatserv.desktop
chmod +x ${APPS_PATH}/devatserv.desktop
chmod +x /opt/devatserv/bin/load-devatserv.sh
chmod +x /opt/devatserv/bin/start-devatserv.sh
chmod +x /opt/devatserv/bin/stop-devatserv.sh
chmod +x /opt/devatserv/share/util/install_docker_lx.sh